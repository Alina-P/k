<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<project basedir="." default="allstr" name="K3Java Build requriements">
	<!-- This is an automatic way of compiling K3.
	To be able to call this script, you will first have to install the appropriate version of
	the stratego-sdf bundle found here: http://strategoxt.org/Stratego/StrategoDownload
	Don't forget to set up the propper execution rights for those programs.
	-->

	<target name="allstr" depends="k2syntax, k3latex, k3" />

	<target name="k2syntax">
		<dependset>
			<srcfileset file="../K3Syntax/trans/*.str" />
			<srcfileset file="../K3Syntax/include/K3Syntax.str" />
			<srcfileset file="../K3Syntax/include/K3Syntax.tbl" />
			<targetfileset dir="src/org/kframework/parser/basic/lib/">
				<include name="*.java" />
				<include name="K3Syntax.tbl" />
				<exclude name="xml_string_escape_from_string_0_0.java" />
				<exclude name="clear_console_0_0.java" />
				<exclude name="get_layout_0_0.java" />
			</targetfileset>
		</dependset>
		<available file="src/org/kframework/parser/basic/lib/K2Str.java" property="k2syntax.available" />
		<antcall target="k2syntax.helper" />
	</target>
	<target name="k2syntax.helper" unless="k2syntax.available">
		<delete file="../K3Syntax/trans/K2Str.rtree" />
		<delete file="../K3Syntax/trans/K2Str.dep" />
		<delete dir="../K3Syntax/trans/K2Str" />
		<java failonerror="true" dir="../K3Syntax/trans/" jar="${basedir}/../../dist/bin/java/strategoxt.jar" fork="true">
			<arg line="-i xmlify.str -o K2Str -la stratego-sglr --lib -I .. -p org.kframework.parser.basic.lib --clean" />
		</java>
		<delete>
			<fileset dir="src/org/kframework/parser/basic/lib">
				<include name="*.java" />
				<include name="K3Syntax.tbl" />
				<exclude name="xml_string_escape_from_string_0_0.java" />
				<exclude name="clear_console_0_0.java" />
				<exclude name="get_layout_0_0.java" />
			</fileset>
		</delete>
		<copy todir="src/org/kframework/parser/basic/lib/">
			<fileset dir="../K3Syntax/trans/K2Str">
				<include name="*" />
			</fileset>
		</copy>
		<delete file="../K3Syntax/trans/K2Str.rtree" />
		<delete file="../K3Syntax/trans/K2Str.dep" />
		<delete dir="../K3Syntax/trans/K2Str" />
	</target>

	<target name="k3latex">
		<dependset>
			<srcfileset file="../LatexComments/trans/*.str" />
			<srcfileset file="../LatexComments/include/LatexComments.str" />
			<srcfileset file="../LatexComments/include/LatexComments.tbl" />
			<targetfileset dir="src/org/kframework/parser/latex/lib">
				<include name="*.java" />
				<include name="LatexComments.tbl" />
			</targetfileset>
		</dependset>
		<available file="src/org/kframework/parser/latex/lib/K3Latex.java" property="k3latex.available" />
		<antcall target="k3latex.helper" />
	</target>
	<target name="k3latex.helper" unless="k3latex.available">
		<delete file="../LatexComments/trans/K3Latex.rtree" />
		<delete file="../LatexComments/trans/K3Latex.dep" />
		<delete dir="../LatexComments/trans/K3Latex" />
		<java failonerror="true" dir="../LatexComments/trans/" jar="${basedir}/../../dist/bin/java/strategoxt.jar" fork="true">
			<arg line="-i xmlify.str -o K3Latex -la stratego-sglr --lib -I .. -p org.kframework.parser.latex.lib --clean" />
		</java>
		<delete>
			<fileset dir="src/org/kframework/parser/latex/lib">
				<include name="*.java" />
				<include name="LatexComments.tbl" />
			</fileset>
		</delete>
		<copy todir="src/org/kframework/parser/latex/lib/">
			<fileset dir="../LatexComments/trans/K3Latex">
				<include name="*" />
			</fileset>
		</copy>
		<delete file="../LatexComments/trans/K3Latex.rtree" />
		<delete file="../LatexComments/trans/K3Latex.dep" />
		<delete dir="../LatexComments/trans/K3Latex" />
	</target>

	<target name="k3">
		<dependset>
			<srcfileset file="../K3Disamb/trans/*.str" />
			<srcfileset file="../K3Disamb/include/K3Disamb.str" />
			<targetfileset dir="src/org/kframework/parser/concrete/lib">
				<include name="*.java" />
				<exclude name="string_trim_last_one_0_0.java" />
				<exclude name="string_unescape_sort_0_0.java" />
				<exclude name="annolocation_0_0.java" />
				<exclude name="annolocationremove_0_0.java" />
				<exclude name="clear_console_0_0.java" />
				<exclude name="mergeamb_0_0.java" />
				<exclude name="xml_string_escape_from_string_0_0.java" />
			</targetfileset>
		</dependset>
		<available file="src/org/kframework/parser/concrete/lib/K3Str.java" property="k3.available" />
		<copy todir="lib/resources/sdf" file="../K3Disamb/syntax/Common.sdf" />
		<copy todir="lib/resources/sdf" file="../K3Disamb/syntax/K3Disamb.sdf" />
		<copy todir="lib/resources/sdf" file="../K3Disamb/syntax/KBuiltinsBasic.sdf" />
		<copy todir="lib/resources/sdf" file="../K3Disamb/syntax/KTechnique.sdf" />
		<antcall target="k3.helper" />
	</target>
	<target name="k3.helper" unless="k3.available">
		<delete file="../K3Disamb/trans/K3Str.rtree" />
		<delete file="../K3Disamb/trans/K3Str.dep" />
		<delete dir="../K3Disamb/trans/K3Str" />
		<java failonerror="true" dir="../K3Disamb/trans/" jar="${basedir}/../../dist/bin/java/strategoxt.jar" fork="true">
			<arg line="-i starter.str -o K3Str -la stratego-sglr --lib -I .. -p org.kframework.parser.concrete.lib --clean" />
		</java>
		<delete>
			<fileset dir="src/org/kframework/parser/concrete/lib">
				<include name="*.java" />
				<exclude name="string_trim_last_one_0_0.java" />
				<exclude name="string_unescape_sort_0_0.java" />
				<exclude name="annolocation_0_0.java" />
				<exclude name="annolocationremove_0_0.java" />
				<exclude name="clear_console_0_0.java" />
				<exclude name="mergeamb_0_0.java" />
				<exclude name="xml_string_escape_from_string_0_0.java" />
			</fileset>
		</delete>
		<copy todir="src/org/kframework/parser/concrete/lib/">
			<fileset dir="../K3Disamb/trans/K3Str">
				<include name="*" />
			</fileset>
		</copy>

		<delete file="../K3Disamb/trans/K3Str.rtree" />
		<delete file="../K3Disamb/trans/K3Str.dep" />
		<delete dir="../K3Disamb/trans/K3Str" />
	</target>
</project>
